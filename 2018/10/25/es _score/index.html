<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>es _score | 找不到星星的猫</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">es _score</h1><a id="logo" href="/.">找不到星星的猫</a><p class="description">keep on learning</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> home</i></a><a href="/archives/"><i class="fa fa-archive"> archive</i></a><a href="/about/"><i class="fa fa-user"> about</i></a><a href="/atom.xml"><i class="fa fa-rss"> rss</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">es _score</h1><div class="post-meta">Oct 25, 2018</div><div class="post-content"><h3 id="lucene-的相关度"><a href="#lucene-的相关度" class="headerlink" title="lucene 的相关度"></a>lucene 的相关度</h3><p>Lucene（或 Elasticsearch）使用 <a href="http://en.wikipedia.org/wiki/Standard_Boolean_model" target="_blank" rel="noopener"><em>布尔模型（Boolean model）</em></a> 查找匹配文档， 并用一个名为 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html" target="_blank" rel="noopener"><em>实用评分函数（practical scoring function）</em></a> 的公式来计算相关度。这个公式借鉴了 <a href="http://en.wikipedia.org/wiki/Tfidf" target="_blank" rel="noopener"><em>词频/逆向文档频率（term frequency/inverse document frequency）</em></a> 和 <a href="http://en.wikipedia.org/wiki/Vector_space_model" target="_blank" rel="noopener"><em>向量空间模型（vector space model）</em></a>，同时也加入了一些现代的新特性，如协调因子（coordination factor），字段长度归一化（field length normalization），以及词或查询语句权重提升</p>
<h4 id="1-布尔模型（boolean-model）"><a href="#1-布尔模型（boolean-model）" class="headerlink" title="1. 布尔模型（boolean model）"></a>1. 布尔模型（boolean model）</h4><p>一个多词查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"text"</span>: <span class="string">"quick fox"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会在内部被重写为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        &#123;<span class="string">"term"</span>: &#123; <span class="string">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"term"</span>: &#123; <span class="string">"text"</span>: <span class="string">"fox"</span>   &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要一个文档与查询匹配，Lucene 就会为查询计算评分，然后合并每个匹配词的评分结果，使用的评分计算公式叫做 <em>实用评分函数</em></p>
<h4 id="2-TF-IDF-算法介绍"><a href="#2-TF-IDF-算法介绍" class="headerlink" title="2. TF/IDF 算法介绍"></a>2. TF/IDF 算法介绍</h4><ul>
<li><strong>TF</strong>: 词频（term frequency） 词在文档中出现的频度</li>
<li><strong>IDF</strong>：逆向文档频率（inversed document frequency)</li>
<li>field-length norm： 字段长度归一值</li>
</ul>
<p>这三个因素是在索引时计算并存储的</p>
<h4 id="3-向量空间模型-vector-space-model"><a href="#3-向量空间模型-vector-space-model" class="headerlink" title="3. 向量空间模型(vector space model)"></a>3. 向量空间模型(vector space model)</h4><p>具体查看： <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/scoring-theory.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/scoring-theory.html</a></p>
<h4 id="4-实用评分函数（-practical-scoring-function）"><a href="#4-实用评分函数（-practical-scoring-function）" class="headerlink" title="4. 实用评分函数（ practical scoring function）"></a>4. 实用评分函数（ practical scoring function）</h4><p>来计算一个 query 对一个 doc 的分数的公式，该函数会使用一个公式来计算</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">score(q,d)  =</span><br><span class="line">            queryNorm(q)</span><br><span class="line">          · coord(q,d)</span><br><span class="line">          · ∑ (</span><br><span class="line">                tf(t <span class="keyword">in</span> d)</span><br><span class="line">              · idf(t)2</span><br><span class="line">              · t.getBoost()</span><br><span class="line">              · norm(t,d)</span><br><span class="line">            ) (t <span class="keyword">in</span> q)</span><br></pre></td></tr></table></figure>
<p>具体请看：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html</a></p>
<h4 id="5-查询协调（query-coodination）"><a href="#5-查询协调（query-coodination）" class="headerlink" title="5. 查询协调（query coodination）"></a>5. 查询协调（query coodination）</h4><p>奖励那些匹配更多字符的 doc 更多的分数</p>
<h4 id="6-field-level-boost"><a href="#6-field-level-boost" class="headerlink" title="6. field level boost"></a>6. field level boost</h4><p>权重的提升会被应用到字段的每个词，而不是字段本身</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">        <span class="string">"title"</span>: &#123;</span><br><span class="line">            <span class="string">"query"</span>: <span class="string">"spark"</span>,</span><br><span class="line">            <span class="string">"boost"</span>: 5</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体查看： <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/query-time-boosting.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/query-time-boosting.html</a></p>
<p>Classic Lucene Similarity 已在 6.3.0 中弃用:</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/index-modules-similarity.html#classic-similarity" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.4/index-modules-similarity.html#classic-similarity</a></p>
<h3 id="es-使用的-BM25-算法"><a href="#es-使用的-BM25-算法" class="headerlink" title="es 使用的 BM25 算法"></a>es 使用的 BM25 算法</h3><p>_search 加参数 explain ,是可以看到 _score 如何计算的,比如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"content"</span>: <span class="string">"到北京"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"size"</span>: 12</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>截取一部分 hits:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "_shard": "[sentences][3]", // 索引为3的分片</span><br><span class="line">    "_node": "sSoxWXsAToKidV9LMeYypg", // node_id</span><br><span class="line">    "_index": "sentences",</span><br><span class="line">    "_type": "_doc",</span><br><span class="line">    "_id": "1",</span><br><span class="line">    "_score": 3.7647452,</span><br><span class="line">    "_source": &#123;</span><br><span class="line">        "content": "查到了快递，已经快到了"</span><br><span class="line">    &#125;,</span><br><span class="line">    "_explanation": &#123;</span><br><span class="line">        "value": 3.7647452,</span><br><span class="line">        "description": "sum of:",</span><br><span class="line">        "details": [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"value"</span>: <span class="number">3.7647452</span>,</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"weight(content:到 in 0) [PerFieldSimilarity], result of:"</span>,</span><br><span class="line">                <span class="attr">"details"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"value"</span>: <span class="number">3.7647452</span>,</span><br><span class="line">                        <span class="attr">"description"</span>: <span class="string">"score(doc=0,freq=2.0 = termFreq=2.0\n), product of:"</span>,</span><br><span class="line">                        <span class="attr">"details"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"value"</span>: <span class="number">2.5758784</span>,</span><br><span class="line">                                "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:", // idf(逆向文档频率) 的计算公式</span><br><span class="line">                                "details": [</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 3, // “到”在该分片中，出现在了 3 个文档中</span><br><span class="line">                                        "description": "docFreq",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 45, // 该分片中共有 45 个文档</span><br><span class="line">                                        "description": "docCount",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"value"</span>: <span class="number">1.4615384</span>,</span><br><span class="line">                                "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:", // tfNorm 计算公式</span><br><span class="line">                                "details": [</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 2, // tf(词频) “到” 在该文档中出现了两次</span><br><span class="line">                                        "description": "termFreq=2.0",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 1.2, // 默认值 1.2</span><br><span class="line">                                        "description": "parameter k1",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 0.75, // 默认值 0.75</span><br><span class="line">                                        "description": "parameter b",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 10.133333, // 平均文档长度</span><br><span class="line">                                        "description": "avgFieldLength",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        "value": 8, // 文档长度</span><br><span class="line">                                        "description": "fieldLength",</span><br><span class="line">                                        "details": []</span><br><span class="line">                                    &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的 hits 可以看出，_score 计算公式：<br>$$<br>score = idf _　\frac{tf _ (k + 1) }{tf + k _ (1 - b +b _ \frac{d}{avgdl})}<br>$$</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">idf = <span class="built_in">log</span>(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5))</span><br><span class="line"><span class="comment"># docCount 某分片字段出现在了几个文档中</span></span><br><span class="line"><span class="comment"># docFreq  同一分片中文档总数</span></span><br><span class="line"><span class="comment"># k 、 b 的相关信息可以查看：</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/6.4/index-modules-similarity.html#bm25</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果不在意词在某个字段中出现的频次，而只在意是否出现过，则可以在字段映射中禁用词频统计:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"mappings"</span>: &#123;</span><br><span class="line">    <span class="string">"doc"</span>: &#123;</span><br><span class="line">      <span class="string">"properties"</span>: &#123;</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">          <span class="string">"type"</span>:          <span class="string">"string"</span>,</span><br><span class="line">          <span class="string">"index_options"</span>: <span class="string">"docs"</span> // 设置成 docs 后，词频都为 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index_options 查看： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-options.html#index-options" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/index-options.html#index-options</a></p>
</li>
<li><p>字段长度的归一值对全文搜索非常重要， 许多其他字段不需要有归一值。无论文档是否包括这个字段，索引中每个文档的每个 <code>string</code> 字段都大约占用 1 个 byte 的空间。对于 <code>not_analyzed</code> 字符串字段的归一值默认是禁用的，而对于 <code>analyzed</code> 字段也可以通过修改字段映射禁用归一值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"mappings"</span>: &#123;</span><br><span class="line">    <span class="string">"doc"</span>: &#123;</span><br><span class="line">      <span class="string">"properties"</span>: &#123;</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">          <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="string">"norms"</span>: &#123; <span class="string">"enabled"</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>norms 查看： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html</a></p>
<p>禁用 norms 后 ，参数 b 为 0、 avgFieldLength、fieldLength 不会计算在内</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"value"</span>: <span class="number">1.375</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1) from:"</span>,</span><br><span class="line">    <span class="attr">"details"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"value"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"termFreq=2.0"</span>,</span><br><span class="line">            <span class="attr">"details"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"value"</span>: <span class="number">1.2</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"parameter k1"</span>,</span><br><span class="line">            <span class="attr">"details"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"value"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"parameter b (norms omitted for field)"</span>,</span><br><span class="line">            <span class="attr">"details"</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 词频 和 文档长度 都禁用，那么 _score 是这样计算的<br>$$<br>score = idf<br>$$</p>
</li>
</ul>
<h3 id="相关度分数优化方法"><a href="#相关度分数优化方法" class="headerlink" title="相关度分数优化方法"></a>相关度分数优化方法</h3><h4 id="1-boost（增加某个-term-的权重）"><a href="#1-boost（增加某个-term-的权重）" class="headerlink" title="1. boost（增加某个 term 的权重）"></a>1. boost（增加某个 term 的权重）</h4><p>这是搜索时提升，索引时提升已在 5.0.0 中弃用，相关信息：<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-boost.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-boost.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"match"</span>: &#123;</span><br><span class="line">            <span class="string">"title"</span>: &#123;</span><br><span class="line">              <span class="string">"query"</span>: <span class="string">"java spark"</span>,</span><br><span class="line">              <span class="string">"boost"</span>: 2</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"match"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"java spark"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"multi_match"</span> : &#123;</span><br><span class="line">    <span class="string">"query"</span>: <span class="string">"some query terms here"</span>,</span><br><span class="line">    <span class="string">"fields"</span>: [ <span class="string">"title^3"</span>, <span class="string">"content"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boost 仅适用于 term queries，prefix, range and fuzzy queries 不会被提升</p>
<h4 id="2-重构查询结构"><a href="#2-重构查询结构" class="headerlink" title="2. 重构查询结构"></a>2. 重构查询结构</h4><p>A or B or (C or D) 结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /forum/article/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"match"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"java"</span> // 权重 1/3</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"match"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"spark"</span> // 权重 1/3</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"bool"</span>: &#123;</span><br><span class="line">            <span class="string">"should"</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">"match"</span>: &#123;</span><br><span class="line">                  <span class="string">"content"</span>: <span class="string">"solution"</span> // 权重 1/6</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">"match"</span>: &#123;</span><br><span class="line">                  <span class="string">"content"</span>: <span class="string">"beginner"</span> // 权重 1/6</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-negative-boost"><a href="#3-negative-boost" class="headerlink" title="3. negative boost"></a>3. negative boost</h4><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-boosting-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-boosting-query.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /forum/article/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"boosting"</span>: &#123;</span><br><span class="line">      <span class="string">"positive"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">          <span class="string">"content"</span>: <span class="string">"java"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"negative"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">          <span class="string">"content"</span>: <span class="string">"spark"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"negative_boost"</span>: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-constant-score"><a href="#4-constant-score" class="headerlink" title="4. constant_score"></a>4. constant_score</h4><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html</a></p>
<p>如果你压根儿不需要相关度评分，直接走 constant_score 加 filter，所有的 doc 分数都是 1，没有评分的概念了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /forum/article/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"constant_score"</span>: &#123;</span><br><span class="line">            <span class="string">"query"</span>: &#123;</span><br><span class="line">              <span class="string">"match"</span>: &#123;</span><br><span class="line">                <span class="string">"title"</span>: <span class="string">"java"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"constant_score"</span>: &#123;</span><br><span class="line">            <span class="string">"query"</span>: &#123;</span><br><span class="line">              <span class="string">"match"</span>: &#123;</span><br><span class="line">                <span class="string">"title"</span>: <span class="string">"spark"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果某个字段更重要，可以使用 boost 增加权重</p>
<h3 id="自定义相关度分数算法"><a href="#自定义相关度分数算法" class="headerlink" title="自定义相关度分数算法"></a>自定义相关度分数算法</h3><p>在 Elasticsearch 中<code>function_score</code>是用于处理文档分值的 DSL，它会在查询结束后对每一个匹配的文档进行一系列的重打分操作，最后以生成的最终分数进行排序。它提供了几种默认的计算分值的函数：</p>
<h4 id="weight：设置权重"><a href="#weight：设置权重" class="headerlink" title="weight：设置权重"></a>weight：设置权重</h4><p>weight 的用法最为简单，只需要设置一个数字作为权重，文档的分数就会乘以该权重。</p>
<p>他最大的用途应该就是和过滤器一起使用了，因为过滤器只会筛选出符合标准的文档，而不会去详细的计算每个文档的具体得分，所以只要满足条件的文档的分数都是 1，而 weight 可以将其更换为你想要的数值</p>
<h4 id="field-value-factor："><a href="#field-value-factor：" class="headerlink" title="field_value_factor："></a>field_value_factor：</h4><p>通过文档中某个字段的值计算出一个分数</p>
<ul>
<li><code>field</code>：指定字段名</li>
<li><p><code>factor</code>：对字段值进行预处理，乘以指定的数值（默认为 1）</p>
</li>
<li><p><code>modifier</code>将字段值进行加工，有以下的几个选项：</p>
<ul>
<li><code>none</code>：不处理</li>
<li><code>log</code>：计算对数</li>
<li><code>log1p</code>：先将字段值 +1，再计算对数</li>
<li><code>log2p</code>：先将字段值 +2，再计算对数</li>
<li><code>ln</code>：计算自然对数</li>
<li><code>ln1p</code>：先将字段值 +1，再计算自然对数</li>
<li><code>ln2p</code>：先将字段值 +2，再计算自然对数</li>
<li><code>square</code>：计算平方</li>
<li><code>sqrt</code>：计算平方根</li>
<li><code>reciprocal</code>：计算倒数</li>
</ul>
<p>举一个简单的例子，假设有一个商品索引，搜索时希望在相关度排序的基础上，销量（<code>sales</code>）更高的商品能排在靠前的位置，那么这条查询 DSL 可以是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"function_score"</span>: &#123;</span><br><span class="line">      <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">          <span class="string">"title"</span>: <span class="string">"雨伞"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="string">"field"</span>: <span class="string">"sales"</span>,</span><br><span class="line">        <span class="string">"modifier"</span>: <span class="string">"log1p"</span>,</span><br><span class="line">        <span class="string">"factor"</span>: 0.1</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"boost_mode"</span>: <span class="string">"sum"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这条查询会将标题中带有雨伞的商品检索出来，然后对这些文档计算一个与库存相关的分数，并与之前相关度的分数相加，对应的公式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_score = _score + <span class="built_in">log</span> (1 + 0.1 * sales)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="random-score"><a href="#random-score" class="headerlink" title="random_score"></a>random_score</h4><p>这个函数的使用相当简单，只需要调用一下就可以返回一个 0 到 1 的分数。</p>
<p>它有一个非常有用的特性是可以通过<code>seed</code>属性设置一个随机种子，该函数保证在随机种子相同时返回值也相同，这点使得它可以轻松地实现对于用户的个性化推荐</p>
<h4 id="衰减函数：同样以某个字段的值为标准，距离某个值越近得分越高"><a href="#衰减函数：同样以某个字段的值为标准，距离某个值越近得分越高" class="headerlink" title="衰减函数：同样以某个字段的值为标准，距离某个值越近得分越高"></a>衰减函数：同样以某个字段的值为标准，距离某个值越近得分越高</h4><p>衰减函数（Decay Function）提供了一个更为复杂的公式，它描述了这样一种情况：对于一个字段，它有一个理想的值，而字段实际的值越偏离这个理想值（无论是增大还是减小），就越不符合期望。这个函数可以很好的应用于数值、日期和地理位置类型，由以下属性组成：</p>
<ul>
<li>原点（<code>origin</code>）：该字段最理想的值，这个值可以得到满分（1.0）</li>
<li>偏移量（<code>offset</code>）：与原点相差在偏移量之内的值也可以得到满分</li>
<li>衰减规模（<code>scale</code>）：当值超出了原点到偏移量这段范围，它所得的分数就开始进行衰减了，衰减规模决定了这个分数衰减速度的快慢</li>
<li>衰减值（<code>decay</code>）：该字段可以被接受的值（默认为 0.5），相当于一个分界点，具体的效果与衰减的模式有关</li>
</ul>
<p>衰减函数还可以指定三种不同的模式：线性函数（linear）、以 e 为底的指数函数（Exp）和高斯函数（gauss），它们拥有不同的衰减曲线：</p>
<p><img src="https://www.scienjus.com/uploads/2016/04/decay-function.png" alt=""></p>
<p>应用场景：租房</p>
<ul>
<li>它的理想位置是公司附近</li>
<li>如果离公司在 5km 以内，是我们可以接受的范围，在这个范围内我们不去考虑距离，而是更偏向于其他信息</li>
<li>当距离超过 5km 时，我们对这套房的评价就越来越低了，直到超出了某个范围就再也不会考虑了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"function_score"</span>: &#123;</span><br><span class="line">      <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">          <span class="string">"title"</span>: <span class="string">"公寓"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"gauss"</span>: &#123;</span><br><span class="line">        <span class="string">"location"</span>: &#123;</span><br><span class="line">          <span class="string">"origin"</span>: &#123; <span class="string">"lat"</span>: 40, <span class="string">"lon"</span>: 116 &#125;,</span><br><span class="line">          <span class="string">"offset"</span>: <span class="string">"5km"</span>,</span><br><span class="line">          <span class="string">"scale"</span>: <span class="string">"10km"</span></span><br><span class="line">           &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="string">"boost_mode"</span>: <span class="string">"sum"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们希望租房的位置在<code>40, 116</code>坐标附近，<code>5km</code>以内是满意的距离，<code>15km</code>以内是可以接受的距离</p>
<h4 id="script-score-：通过自定义脚本计算分值"><a href="#script-score-：通过自定义脚本计算分值" class="headerlink" title="script_score`：通过自定义脚本计算分值"></a>script_score`：通过自定义脚本计算分值</h4><p>虽然强大的 field_value_factor 和衰减函数已经可以解决大部分问题了，但是也可以看出它们还有一定的局限性：</p>
<ol>
<li><p>这两种方式都只能针对一个字段计算分值</p>
</li>
<li><p>这两种方式应用的字段类型有限，field_value_factor 一般只用于数字类型，而衰减函数一般只用于数字、位置和时间类型</p>
<p> 这时候就需要 script_score 了，它支持我们自己编写一个脚本运行，在该脚本中我们可以拿到当前文档的所有字段信息，并且只需要将计算的分数作为返回值传回 Elasticsearch 即可。</p>
<p> 注：使用脚本需要首先在配置文件中打开相关功能：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">script.groovy.sandbox.enabled: true</span><br><span class="line">script.inline: on</span><br><span class="line">script.indexed: on</span><br><span class="line">script.search: on</span><br><span class="line">script.engine.groovy.inline.aggs: on</span><br></pre></td></tr></table></figure>
<p>举一个之前做不到的例子，假如我们有一个位置索引，它有一个分类（<code>category</code>）属性，该属性是字符串枚举类型，例如商场、电影院或者餐厅等。现在由于我们有一个电影相关的活动，所以需要将电影院在搜索列表中的排位相对靠前。</p>
<p>之前的两种方式都无法给字符串打分，但是如果我们自己写脚本的话却很简单，使用 Groovy（Elasticsearch 的默认脚本语言）也就是一行的事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return doc [&apos;category&apos;].value == &apos;电影院&apos; ? 1.1 : 1.0</span><br></pre></td></tr></table></figure>
<p>接下来只要将这个脚本配置到查询语句中就可以了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;天安门&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;script_score&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &quot;return doc [&apos;category&apos;].value == &apos;电影院&apos; ? 1.1 : 1.0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或是将脚本放在<code>elasticsearch/config/scripts</code>下，然后在查询语句中引用它：</p>
<p>category-score.groovy：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return doc [&apos;category&apos;].value == &apos;电影院&apos; ? 1.1 : 1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;天安门&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;script_score&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">         &quot;file&quot;: &quot;category-score&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>script</code>中还可以通过<code>params</code>属性向脚本传值，所以为了解除耦合，上面的 DSL 还能接着改写为：</p>
<p>category-score.groovy：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">return doc [&apos;category&apos;].value == recommend_category ? 1.1 : 1.0</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;天安门&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;script_score&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">         &quot;file&quot;: &quot;category-score&quot;,</span><br><span class="line">         &quot;params&quot;: &#123;</span><br><span class="line">            &quot;recommend_category&quot;: &quot;电影院&quot;</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以在不更改大部分查询语句和脚本的基础上动态修改推荐的位置类别了。</p>
<h4 id="boost-mode"><a href="#boost-mode" class="headerlink" title="boost_mode"></a>boost_mode</h4><p>它还有一个属性<code>boost_mode</code>可以指定计算后的分数与原始的<code>_score</code>如何合并，有以下选项：</p>
<ul>
<li><code>multiply</code>：将结果乘以<code>_score</code></li>
<li><code>sum</code>：将结果加上<code>_score</code></li>
<li><code>min</code>：取结果与<code>_score</code>的较小值</li>
<li><code>max</code>：取结果与<code>_score</code>的较大值</li>
<li><code>replace</code>：使结果替换掉<code>_score</code></li>
</ul>
<h4 id="同时使用多个函数"><a href="#同时使用多个函数" class="headerlink" title="同时使用多个函数"></a>同时使用多个函数</h4><p>上面的例子都只是调用某一个函数并与查询得到的<code>_score</code>进行合并处理，而在实际应用中肯定会出现在多个点上计算分值并合并，虽然脚本也许可以解决这个问题，但是应该没人愿意维护一个复杂的脚本吧。这时候通过多个函数将每个分值都计算出在合并才是更好的选择。在 function_score 中可以使用<code>functions</code>属性指定多个函数。它是一个数组，所以原有函数不需要发生改动。同时还可以通过<code>score_mode</code>指定各个函数分值之间的合并处理，值跟最开始提到的<code>boost_mode</code>相同。</p>
<p>下面举两个例子介绍一些多个函数混用的场景。</p>
<p>第一个例子是类似于大众点评的餐厅应用。该应用希望向用户推荐一些不错的餐馆，特征是：范围要在当前位置的 5km 以内，有停车位是最重要的，有 Wi-Fi 更好，餐厅的评分（1 分到 5 分）越高越好，并且对不同用户最好展示不同的结果以增加随机性。</p>
<p>那么它的查询语句应该是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"function_score"</span>: &#123;</span><br><span class="line">      <span class="string">"filter"</span>: &#123;</span><br><span class="line">        <span class="string">"geo_distance"</span>: &#123;</span><br><span class="line">          <span class="string">"distance"</span>: <span class="string">"5km"</span>,</span><br><span class="line">          <span class="string">"location"</span>: &#123;</span><br><span class="line">            <span class="string">"lat"</span>: <span class="variable">$lat</span>,</span><br><span class="line">            <span class="string">"lon"</span>: <span class="variable">$lng</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"functions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"filter"</span>: &#123;</span><br><span class="line">            <span class="string">"term"</span>: &#123;</span><br><span class="line">              <span class="string">"features"</span>: <span class="string">"wifi"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"weight"</span>: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"filter"</span>: &#123;</span><br><span class="line">            <span class="string">"term"</span>: &#123;</span><br><span class="line">              <span class="string">"features"</span>: <span class="string">"停车位"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"weight"</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"field_value_factor"</span>: &#123;</span><br><span class="line">               <span class="string">"field"</span>: <span class="string">"score"</span>,</span><br><span class="line">               <span class="string">"factor"</span>: 1.2</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"random_score"</span>: &#123;</span><br><span class="line">            <span class="string">"seed"</span>: <span class="string">"<span class="variable">$id</span>"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"score_mode"</span>: <span class="string">"sum"</span>,</span><br><span class="line">      <span class="string">"boost_mode"</span>: <span class="string">"multiply"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：其中所有以<code>$</code>开头的都是变量。这样一个饭馆的最高得分应该是 2 分（有停车位）+ 1 分（有 wifi）+ 6 分（评分 5 分 * 1.2）+ 1 分（随机评分）。</p>
<p>另一个例子是类似于新浪微博的社交网站。现在要优化搜索功能，使其以文本相关度排序为主，但是越新的微博会排在相对靠前的位置，点赞（忽略相同计算方式的转发和评论）数较高的微博也会排在较前面。如果这篇微博购买了推广并且是创建不到 24 小时（同时满足），它的位置会非常靠前。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"function_score"</span>: &#123;</span><br><span class="line">      <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">          <span class="string">"content"</span>: <span class="string">"<span class="variable">$text</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"functions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"gauss"</span>: &#123;</span><br><span class="line">            <span class="string">"createDate"</span>: &#123;</span><br><span class="line">              <span class="string">"origin"</span>: <span class="string">"<span class="variable">$now</span>"</span>,</span><br><span class="line">              <span class="string">"scale"</span>: <span class="string">"6d"</span>,</span><br><span class="line">              <span class="string">"offset"</span>: <span class="string">"1d"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field_value_factor"</span>: &#123;</span><br><span class="line">            <span class="string">"field"</span>: <span class="string">"like_count"</span>,</span><br><span class="line">            <span class="string">"modifier"</span>: <span class="string">"log1p"</span>,</span><br><span class="line">            <span class="string">"factor"</span>: 0.1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"script_score"</span>: &#123;</span><br><span class="line">            <span class="string">"script"</span>: <span class="string">"return doc ['is_recommend'].value &amp;&amp; doc ['create_date'] &gt; time ? 1.5 : 1.0"</span>,</span><br><span class="line">            params: &#123;</span><br><span class="line">                <span class="string">"time"</span>: <span class="variable">$time</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"boost_mode"</span>: <span class="string">"multiply"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的公式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_score * gauss (create_date, <span class="variable">$now</span>, <span class="string">"1d"</span>, <span class="string">"6d"</span>) * <span class="built_in">log</span> (1 + 0.1 * like_count) * is_recommend ? 1.5 : 1.0</span><br></pre></td></tr></table></figure>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><p><a href="https://www.scienjus.com/elasticsearch-function-score-query/" target="_blank" rel="noopener">通过 Function Score Query 优化 Elasticsearch 搜索结果</a></p>
</li>
<li><p><a href="https://blog.csdn.net/wuzhiwei549/article/details/80434603" target="_blank" rel="noopener">Elasticsearch 之（22） 自定义相关度分数算法 和 常见的相关度分数优化方法</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/scoring-theory.html" target="_blank" rel="noopener"> 相关度评分背后的理论</a></p>
</li>
<li><p><a href="https://ruby-china.org/topics/node39" target="_blank" rel="noopener">搜索引擎 ElasticSearch 的分数是怎么计算得出 (2.X &amp; 5.X)</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/27951938" target="_blank" rel="noopener">ElasticSearch 相关性打分机制</a></p>
</li>
<li><p><a href="http://zh1cheung.com/zhi1cheung.github.io/elk/2018/09/19/elk/" target="_blank" rel="noopener">elasticsearch(九)</a></p>
</li>
<li><p><a href="https://juejin.im/entry/5b7b7a23e51d453894001387" target="_blank" rel="noopener">干货 | Elasticsearch 通用优化建议</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/practical-scoring-function.html" target="_blank" rel="noopener"> Lucene 的实用评分函数</a></p>
</li>
<li><p><a href="https://opensourceconnections.com/blog/2015/10/16/bm25-the-next-generation-of-lucene-relevation/" target="_blank" rel="noopener">BM25 The Next Generation of Lucene Relevance</a></p>
</li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2018/10/23/es search API &amp; query DSL/">es search API &amp; query DSL</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/25/es _score/">es _score</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/es search API & query DSL/">es search API & query DSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/12/数据库/">Mysql数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/12/安装 elasticsearch-analysis-pinyin/">安装 elasticsearch-analysis-pinyin</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/hexo browsersync插件的使用/">hexo browsersync插件的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/jsonp的原理/">jsonp的原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/song/"><<  消愁 >> --- 毛不易</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">找不到星星的猫.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>