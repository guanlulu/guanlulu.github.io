<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>es search API &amp; query DSL | 找不到星星的猫</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">es search API &amp; query DSL</h1><a id="logo" href="/.">找不到星星的猫</a><p class="description">keep on learning</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">es search API &amp; query DSL</h1><div class="post-meta">Oct 23, 2018</div><div class="post-content"><h3 id="search-API"><a href="#search-API" class="headerlink" title="search API"></a>search API</h3><h4 id="1-多索引"><a href="#1-多索引" class="headerlink" title="1. 多索引"></a>1. 多索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"localhost:9200/twitter,elasticsearch/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;    </span></span><br><span class="line"><span class="string">	"query" : &#123;</span></span><br><span class="line"><span class="string">        "match": &#123; </span></span><br><span class="line"><span class="string">        	"content": "把手"</span></span><br><span class="line"><span class="string">         &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line">// 搜索所有可用的索引</span><br><span class="line">curl -XPOST <span class="string">"localhost:9200/_all/_search"</span> ...</span><br></pre></td></tr></table></figure>
<p>常用的参数：</p>
<ul>
<li><p>explain:  默认 false , 设为 true 时，返回结果包含如何计算命中得分的解释</p>
</li>
<li><p>_source： 设置为 false 禁用 _source 字段检索，还可以使用 _source_include 和 _source_exclude ，检索部      分文档</p>
</li>
<li><p>from： 从命中的索引开始返回。默认为 0</p>
</li>
<li><p>size： 要返回的点击次数。默认为 10</p>
<p>其他参数，查看： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-uri-request.html" target="_blank" rel="noopener">uri search</a></p>
</li>
</ul>
<h4 id="2-source-filter"><a href="#2-source-filter" class="headerlink" title="2. source filter"></a>2. source filter</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_source"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// "_source": "obj.*",  // 通配符模式</span></span><br><span class="line">    <span class="comment">// "_source": [ "obj1.*", "obj2.*" ],</span></span><br><span class="line">    <span class="comment">// "_source": &#123;</span></span><br><span class="line">    <span class="comment">//  	"includes": [ "obj1.*", "obj2.*" ],</span></span><br><span class="line">    <span class="comment">//   	"excludes": [ "*.description" ]</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"query"</span> : &#123;</span><br><span class="line">        <span class="string">"term"</span> : &#123; <span class="string">"user"</span> : <span class="string">"kimchy"</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-highlight"><a href="#3-highlight" class="headerlink" title="3. highlight"></a>3. highlight</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query" : &#123;</span></span><br><span class="line"><span class="string">        "match": &#123; "content": "kimchy" &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "highlight" : &#123;</span></span><br><span class="line"><span class="string">    	"pre_tags" : ["&lt;tag1&gt;"],</span></span><br><span class="line"><span class="string">        "post_tags" : ["&lt;/tag1&gt;"],</span></span><br><span class="line"><span class="string">        "fields" : &#123;</span></span><br><span class="line"><span class="string">            "content" : &#123;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>更多 highlight 参数 ，查看：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-request-highlighting.html#configure-tags" target="_blank" rel="noopener">Highlighting</a></p>
<h4 id="4-Multi-Search-API"><a href="#4-Multi-Search-API" class="headerlink" title="4. Multi Search API"></a>4. Multi Search API</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/twitter/_msearch"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">&#123;"query" : &#123;"match_all" : &#123;&#125;&#125;, "from" : 0, "size" : 10&#125;</span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">&#123;"query" : &#123;"match_all" : &#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"index" : "twitter2"&#125;</span></span><br><span class="line"><span class="string">&#123;"query" : &#123;"match_all" : &#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>支持模板，查看： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-multi-search.html" target="_blank" rel="noopener">Multi Search API</a></p>
<h3 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h3><p>ES提供了基于JSON的query DSL查询语言，有两种类型子句： </p>
<ol>
<li>Leaf query。查找特定字段的特定值。如match、term、range查询。 </li>
<li>Compound query。wrap other leaf or compound queries。以一种含有逻辑（如bool、dis_max查询）的方式组合多个查询，或改变查询行为(如constant_score查询)<br>Query clauses behave differently depending on whether they are used in query context or filter context.</li>
</ol>
<h4 id="1-Query-and-filter-context"><a href="#1-Query-and-filter-context" class="headerlink" title="1. Query and filter context"></a>1. Query and filter context</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123; </span></span><br><span class="line"><span class="string">    "bool": &#123; </span></span><br><span class="line"><span class="string">      "must": [</span></span><br><span class="line"><span class="string">        &#123; "match": &#123; "title":   "Search"        &#125;&#125;, </span></span><br><span class="line"><span class="string">        &#123; "match": &#123; "content": "Elasticsearch" &#125;&#125;  </span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      "filter": [ </span></span><br><span class="line"><span class="string">        &#123; "term":  &#123; "status": "published" &#125;&#125;, </span></span><br><span class="line"><span class="string">        &#123; "range": &#123; "publish_date": &#123; "gte": "2015-01-01" &#125;&#125;&#125; </span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>query</code>参数表示查询上下文</p>
</li>
<li><p><code>filter</code>参数表示过滤器上下文,他们会过滤掉不匹配的文件，但不会影响匹配文件的分数</p>
</li>
<li><p><code>tip</code>:  在查询上下文中使用查询子句，以了解应该影响匹配文档的分数的条件（即文档的匹配程度），并在过滤器上下文中使用所有其他查询子句</p>
</li>
</ul>
<h4 id="2-Match-All-Query"><a href="#2-Match-All-Query" class="headerlink" title="2. Match All Query"></a>2. Match All Query</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<h4 id="3-Full-text-queries"><a href="#3-Full-text-queries" class="headerlink" title="3. Full text queries"></a>3. Full text queries</h4><h5 id="3-1-Match-Query"><a href="#3-1-Match-Query" class="headerlink" title="3.1  Match Query"></a>3.1  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-match-query.html" target="_blank" rel="noopener">Match Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match" : &#123;</span></span><br><span class="line"><span class="string">            "message" : "this is a test"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>message</code>是字段的名称，可以替换任何字段的名称</li>
</ul>
<h6 id="3-1-1-boolean-match"><a href="#3-1-1-boolean-match" class="headerlink" title="3.1.1 boolean match"></a>3.1.1 boolean match</h6><p>match会将搜索输入进行分析，分析结果就是得到一个布尔查询。对此可简单理解为：“this is a test”，被分析为[“this”, “test”]，然后检索就变成了对于“this”和“test”的两个词的联合查询，默认的布尔连接操作符是<code>or</code>。不过，可以通过参数来改变布尔操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match" : &#123;</span></span><br><span class="line"><span class="string">            "message" : &#123;</span></span><br><span class="line"><span class="string">                "query" : "this is a test",</span></span><br><span class="line"><span class="string">                "operator" : "and" </span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意结构上的细小变化</li>
</ul>
<h5 id="3-2-Match-Phrase-Query"><a href="#3-2-Match-Phrase-Query" class="headerlink" title="3.2  Match Phrase Query"></a>3.2  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-match-query-phrase.html#query-dsl-match-query-phrase" target="_blank" rel="noopener">Match Phrase Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_phrase" : &#123;</span></span><br><span class="line"><span class="string">            "message" : &#123;</span></span><br><span class="line"><span class="string">                "query" : "this is a test",</span></span><br><span class="line"><span class="string">                "analyzer" : "my_analyzer"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>analyzer</code>  默认为字段显式映射定义或默认搜索分析器</li>
<li><p><code>match_phrase</code> 查询首先将查询字符串解析成一个词项列表，然后对这些词项进行搜索，但只保留那些包含 <em>全部</em> 搜索词项，且 <em>位置</em> 与搜索词项相同的文档</p>
</li>
<li><p>一个小例子，助于理解：</p>
<p>一个被认定为和短语 <code>quick brown fox</code> 匹配的文档，必须满足以下这些要求：</p>
<ul>
<li><code>quick</code> 、 <code>brown</code> 和 <code>fox</code> 需要全部出现在域中。</li>
<li><code>brown</code> 的位置应该比 <code>quick</code> 的位置大 <code>1</code> 。</li>
<li><code>fox</code> 的位置应该比 <code>quick</code> 的位置大 <code>2</code> 。</li>
</ul>
<p>如果以上任何一个选项不成立，则该文档不能认定为匹配。</p>
</li>
</ul>
<h5 id="3-3-Match-Phrase-Prefix-Query"><a href="#3-3-Match-Phrase-Prefix-Query" class="headerlink" title="3.3  Match Phrase Prefix Query"></a>3.3  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-match-query-phrase-prefix.html" target="_blank" rel="noopener">Match Phrase Prefix Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_phrase_prefix" : &#123;</span></span><br><span class="line"><span class="string">            "message" : "quick brown f",</span></span><br><span class="line"><span class="string">            "max_expansions" : 10,</span></span><br><span class="line"><span class="string">            "slop": 10</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>将查询字符串的最后一个词作为前缀使用</p>
</li>
<li><p><code>max_expansions</code>   控制着可以与前缀匹配的词的数量</p>
</li>
<li><code>slop</code>   让相对词序位置不那么严格</li>
<li>可以实现即时查询</li>
<li>官方文档建议： For better solutions for <em>search-as-you-type</em> see the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-suggesters-completion.html" target="_blank" rel="noopener">completion suggester</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/guide/master/_index_time_search_as_you_type.html" target="_blank" rel="noopener">Index-Time Search-as-You-Type</a>.</li>
</ul>
<h5 id="3-4-Multi-Match-Query"><a href="#3-4-Multi-Match-Query" class="headerlink" title="3.4   Multi Match Query"></a>3.4   <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-multi-match-query.html" target="_blank" rel="noopener">Multi Match Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "multi_match" : &#123;</span></span><br><span class="line"><span class="string">      "query":    "Will Smith",</span></span><br><span class="line"><span class="string">      "fields": [ "title", "*_name" ] </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>可以使用通配符指定字段</p>
</li>
<li><p>一次查询的字段数不得超过1024个</p>
</li>
<li><code>multi_match</code>  有3种查询类型,查看： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-multi-match-query.html" target="_blank" rel="noopener">Multi Match Query</a></li>
</ul>
<h5 id="3-5-Common-Terms-Query"><a href="#3-5-Common-Terms-Query" class="headerlink" title="3.5  Common Terms Query"></a>3.5  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-common-terms-query.html" target="_blank" rel="noopener">Common Terms Query</a></h5><p><code>common</code>查询的应用场景在于检索里包括的词项中有stopword，但是这里的stopword由于其语境不同所以不再是通常意义的stopword，相反，必须将该词项考虑到检索和计分中去。使用<code>common</code>查询将可以完成该项工作，并且不会牺牲掉检索性能</p>
<h5 id="3-6-Query-String-Query"><a href="#3-6-Query-String-Query" class="headerlink" title="3.6  Query String Query"></a>3.6  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-query-string-query.html" target="_blank" rel="noopener">Query String Query</a></h5><p>可以用一些运算符 AND OR</p>
<h4 id="4-Term-level-queries"><a href="#4-Term-level-queries" class="headerlink" title="4. Term level queries"></a>4. Term level queries</h4><h5 id="4-1-Term-Query"><a href="#4-1-Term-Query" class="headerlink" title="4.1  Term Query"></a>4.1  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-term-query.html" target="_blank" rel="noopener">Term Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "term" : &#123; "user" : "Kimchy" &#125; </span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>term</code> 查询被用于精确值匹配，这些精确值可能是数字、时间、布尔或者那些 <code>not_analyzed</code> 的字符串</li>
</ul>
<h5 id="4-2-Terms-Query"><a href="#4-2-Terms-Query" class="headerlink" title="4.2  Terms Query"></a>4.2  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-terms-query.html" target="_blank" rel="noopener">Terms Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "terms" : &#123; "user" : ["kimchy", "elasticsearch"]&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>terms</code>   指定多值进行精确值匹配。如果这个字段包含了指定值中的任何一个值，那么这个文档满足条件</li>
</ul>
<h5 id="4-3-Range-Query"><a href="#4-3-Range-Query" class="headerlink" title="4.3  Range Query"></a>4.3  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-range-query.html" target="_blank" rel="noopener">Range Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "range" : &#123;</span></span><br><span class="line"><span class="string">            "age" : &#123;</span></span><br><span class="line"><span class="string">                "gte" : 10,</span></span><br><span class="line"><span class="string">                "lte" : 20,</span></span><br><span class="line"><span class="string">                "boost" : 2.0</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "range" : &#123;</span></span><br><span class="line"><span class="string">            "date" : &#123;</span></span><br><span class="line"><span class="string">                "gte" : "now-1d/d",</span></span><br><span class="line"><span class="string">                "lt" :  "now/d"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在针对日期类型字段使用<code>range</code>查询时，可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#date-math" target="_blank" rel="noopener">Date Match</a>表示方法。使用时也可以灵活运用Date Format</li>
</ul>
<h5 id="4-4-Exists-Query"><a href="#4-4-Exists-Query" class="headerlink" title="4.4  Exists Query"></a>4.4  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-exists-query.html#query-dsl-exists-query" target="_blank" rel="noopener">Exists Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "exists" : &#123; "field" : "user" &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "bool": &#123;</span></span><br><span class="line"><span class="string">            "must_not": &#123;</span></span><br><span class="line"><span class="string">                "exists": &#123;</span></span><br><span class="line"><span class="string">                    "field": "user"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>exists</code> 查询被用于查找那些指定字段中有值 (<code>exists</code>) 或无值 (<code>missing</code>) 的文档</li>
</ul>
<h5 id="4-5-Prefix-Query"><a href="#4-5-Prefix-Query" class="headerlink" title="4.5  Prefix Query"></a>4.5  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-prefix-query.html#query-dsl-prefix-query" target="_blank" rel="noopener">Prefix Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123; "query": &#123;</span></span><br><span class="line"><span class="string">    "prefix" : &#123; "user" : "ki" &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对中文好像用处不大</li>
</ul>
<h4 id="5-Compound-queries"><a href="#5-Compound-queries" class="headerlink" title="5. Compound queries"></a>5. Compound queries</h4><h5 id="5-1-Bool-Query"><a href="#5-1-Bool-Query" class="headerlink" title="5.1 Bool Query"></a>5.1 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-bool-query.html" target="_blank" rel="noopener">Bool Query</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"localhost:9200/_search"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "bool" : &#123;</span></span><br><span class="line"><span class="string">      "must" : &#123;</span></span><br><span class="line"><span class="string">        "term" : &#123; "user" : "kimchy" &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      "filter": &#123;</span></span><br><span class="line"><span class="string">        "term" : &#123; "tag" : "tech" &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      "must_not" : &#123;</span></span><br><span class="line"><span class="string">        "range" : &#123;</span></span><br><span class="line"><span class="string">          "age" : &#123; "gte" : 10, "lte" : 20 &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      "should" : [</span></span><br><span class="line"><span class="string">        &#123; "term" : &#123; "tag" : "wow" &#125; &#125;,</span></span><br><span class="line"><span class="string">        &#123; "term" : &#123; "tag" : "elasticsearch" &#125; &#125;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      "minimum_should_match" : 1,</span></span><br><span class="line"><span class="string">      "boost" : 1.0</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>minimum_should_match</strong> 控制文档必须满足should子句中的子查询条件的数量</li>
<li><p>布尔查询支持的子查询类型共有四种，分别是：must，should，must_not和filter：</p>
<ul>
<li><strong>must </strong>: 文档必须匹配must查询条件</li>
<li><strong>should</strong>：文档应该匹配should子句查询的一个或多个</li>
<li><strong>must_not</strong>:  文档不能匹配该查询条件</li>
<li><strong>filter</strong>:  过滤器，文档必须匹配该过滤条件，跟must子句的唯一区别是，filter不影响查询的score</li>
</ul>
</li>
<li><p>布尔查询的四个子句，都可以是数组字段，因此，支持嵌套逻辑操作的查询</p>
</li>
<li>布尔查询的各个子句之间的逻辑关系是与（and），这意味着，一个文档只有同时满足所有的查询子句时，该文档才匹配查询条件，作为结果返回</li>
<li>在布尔查询中，对查询结果的过滤，建议使用过滤（filter）子句和must_not子句，这两个子句属于过滤上下文（Filter Context），经常使用filter子句，使得ElasticSearch引擎自动缓存数据，当再次搜索已经被缓存的数据时，能够提高查询性能；由于过滤上下文不影响查询的评分，而评分计算让搜索变得复杂，消耗更多CPU资源，因此，filter和must_not查询减轻搜索的工作负载</li>
</ul>
<h6 id="5-1-1-使用布尔查询实现复杂的分组查询"><a href="#5-1-1-使用布尔查询实现复杂的分组查询" class="headerlink" title="5.1.1 使用布尔查询实现复杂的分组查询"></a>5.1.1 <strong>使用布尔查询实现复杂的分组查询</strong></h6><p>复杂的分组查询，例如：(A and B) or (C and D) or (E and F) ，把布尔查询作为should子句的一个子查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_source"</span>: <span class="string">"topics"</span>,</span><br><span class="line">  <span class="string">"from"</span>: 0,</span><br><span class="line">  <span class="string">"size"</span>: 100,</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">      <span class="string">"should"</span>: [</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="string">"bool"</span>: &#123;</span><br><span class="line">            <span class="string">"must"</span>: [</span><br><span class="line">              &#123; <span class="string">"term"</span>: &#123; <span class="string">"topics"</span>: 1&#125;  &#125;,</span><br><span class="line">              &#123; <span class="string">"term"</span>: &#123; <span class="string">"topics"</span>: 2&#125;  &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"bool"</span>: &#123;</span><br><span class="line">            <span class="string">"must"</span>: [</span><br><span class="line">              &#123;<span class="string">"term"</span>: &#123; <span class="string">"topics"</span>: 3 &#125; &#125;,</span><br><span class="line">              &#123;<span class="string">"term"</span>: &#123; <span class="string">"topics"</span>: 4&#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"minimum_should_match"</span>: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h3><ol>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener">Query DSL</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/ljhdo/p/5040252.html" target="_blank" rel="noopener">ElasticSearch查询 第五篇：布尔查询</a></p>
</li>
<li><p><a href="https://my.oschina.net/yumg/blog/637409" target="_blank" rel="noopener">Elasticseach Query DSL</a></p>
</li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2018/10/12/数据库/">Mysql数据库</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/es search API & query DSL/">es search API & query DSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/12/数据库/">Mysql数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/12/安装 elasticsearch-analysis-pinyin/">安装 elasticsearch-analysis-pinyin</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/hexo browsersync插件的使用/">hexo browsersync插件的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/jsonp的原理/">jsonp的原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/song/"><<  消愁 >> --- 毛不易</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">找不到星星的猫.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>